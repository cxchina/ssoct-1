function resampled_Bmodescan = resample_B_scan(Bmodescan)
% The assumption is that each A-line in the B scan is sampled at a fixed
% frequency, then it is interpolated using a known sampling function, obtained
% from the k-clock (swept source laser output)
% SYNTAX:
% resampled_Bmodescan = resample_B_scan(Bmodescan)
% INPUTS:
% Bmodescan: 2D image
% OUTPUTS:
% resampled_Bmodescan: non-linear sampling corrected along A-lines
%_______________________________________________________________________________
% Copyright (C) 2010 Laboratoire d'Imagerie Optique et Moleculaire
% Frederic Lesage, Edgar Guevara
% 2011/10/12

% Modifies values of global variable
global ssOCTdefaults

% Checking if Bmodescan is uint16
if isinteger(Bmodescan)                 
    Bmodescan = double(Bmodescan);
    FLAG_int = true;
else
    FLAG_int = false;
end

%%
% Position when sampling at a fixed frequency (125 MHz)
fixedSampling = linspace(0,ssOCTdefaults.NSAMPLES - 1,ssOCTdefaults.NSAMPLES)';
% Position with k-clock sampling (variable sampling frequency)
kClockSampling = [0;0.000000001;0.333333333333333;1;1.66666666666667;2.33333333333333;2.66666666666667;3.33333333333333;4.00000000000000;4.66666666666667;5.33333333333333;6;6.66666666666667;7.33333333333333;8;8.66666666666667;9.33333333333333;9.66666666666667;10.3333333333333;10.6666666666667;11.3333333333333;12;12.6666666666667;13.3333333333333;14;14.6666666666667;15.3333333333333;16.0000000000000;16.6666666666667;17.3333333333333;18;18.6666666666667;19.3333333333333;20;20.6666666666667;21.3333333333333;22;22.6666666666667;23.3333333333333;24;25;25.6666666666667;26.3333333333333;27.0000000000000;27.6666666666667;28.3333333333333;29;30.0000000000000;30.6666666666667;31.3333333333333;32;32.6666666666667;33.3333333333333;33.6666666666667;34.3333333333333;35;36;36.6666666666667;37.3333333333333;38;39;39.6666666666667;40.3333333333333;41;42;43;43.6666666666667;44.3333333333333;45;46;46.6666666666667;47.3333333333333;48;49.0000000000000;50;50.6666666666667;51.3333333333333;52.0000000000000;53;54;54.6666666666667;55.3333333333333;56;57;57.6666666666667;58.3333333333333;59.6666666666667;60.3333333333333;61;61.0000000000000;62;63;64.0000000000000;64.6666666666667;65.3333333333333;66;67;68;69;69.6666666666667;70.3333333333333;71;72;73;74;75.6666666666667;76.3333333333333;77;77;78;79;80;81;82;82.6666666666667;83.3333333333333;84;85;85.6666666666667;86.3333333333333;87;88;89;90;91.3333333333333;92.6666666666667;94;95;96;97;98.3333333333333;99.6666666666667;101;102.000000000000;103;104;105.000000000000;106;107;108.000000000000;109.333333333333;110.666666666667;112.333333333333;113.666666666667;115;116;117.000000000000;118;118.666666666667;119.333333333333;120.000000000000;120.666666666667;121.333333333333;122;123.000000000000;124;125;126.000000000000;127;128;129;130;131;132;133;134;135;136;136.333333333333;137.333333333333;139;140.333333333333;141;141;142;143;144;145;146;147;148;149;150;151;151.666666666667;152.333333333333;153;154;155;156;157;158;159;160;161;162;163;164;165;166;167;168;169;170;171;172;173;174;175;176;177;178;179;180;181;182;183;183.666666666667;184;185;187;188.666666666667;189.666666666667;190;191;192;193.000000000000;194;195;196.000000000000;197;198;199.000000000000;200;201;202.000000000000;203;204;205.000000000000;206;207;208.000000000000;209;211.333333333333;212.666666666667;214;214.000000000000;215;216;217.000000000000;218;218.666666666667;219.333333333333;220.000000000000;221;222;223.000000000000;224;225;226.000000000000;227;227.666666666667;229;230.333333333333;232.000000000000;233;234;235.000000000000;236;237;238.000000000000;239;240;241.000000000000;243;244.333333333333;245.666666666667;246;247.000000000000;248;249;250.000000000000;251;252;253.000000000000;253.666666666667;254.333333333333;255.333333333333;256;257.333333333333;258.333333333333;260;261;262;263;264;265;266.333333333333;268;269.666666666667;271;272;273;274;275;276;277.333333333333;278.666666666667;279.666666666667;280.666666666667;281.666666666667;283.333333333333;284.666666666667;286;287;288;289.666666666667;291.333333333333;292.666666666667;293.333333333333;294;295.333333333333;296.666666666667;298;299;300;301.333333333333;302.666666666667;304;305;306;307;308;309;308.333333333333;309.666666666667;311.333333333333;315.333333333333;316.333333333333;317.666666666667;318.333333333333;320;321;323;324.333333333333;325.666666666667;326;327;328;329;330;331;331.666666666667;332;333;334.333333333333;336;337;338;339;340;341.333333333333;342.666666666667;344;345;346;347;348;349;348.333333333333;349.666666666667;351;354;355;356;357;358;359.333333333333;360.666666666667;362;363;364;365;366;367;367.666666666667;368.666666666667;369.666666666667;371;372;373;374;375;376;377.333333333333;378.666666666667;380;381;382;383;383.666666666667;385;386.333333333333;388;389;390.000000000000;391;392;393.333333333333;394.666666666667;396.000000000000;397;398;399.000000000000;400;401;402.333333333333;403.666666666667;404.666666666667;405.333333333333;406;407;408.000000000000;409;410.333333333333;411.666666666667;413;414.000000000000;415;416;417.000000000000;418.333333333333;419.666666666667;421;422;423.000000000000;424;425.333333333333;426.666666666667;428;429.000000000000;430;431;432.000000000000;433.333333333333;434.666666666667;436;437;438.000000000000;439;440;441.333333333333;442.333333333333;443.333333333333;444.000000000000;445;446;447.000000000000;448;449.333333333333;450.666666666667;452;453.000000000000;454;455;455.666666666667;457;458.333333333333;460;461;462.000000000000;463;464.333333333333;465.666666666667;467;468.000000000000;469;470;471.333333333333;472.666666666667;474.000000000000;475;476;477.000000000000;478;478.666666666667;479.666666666667;480.666666666667;482;483.000000000000;484;485;484.666666666667;486;487.333333333333;490;491;492.000000000000;493;494.333333333333;495.666666666667;497;498.000000000000;499;500;501.000000000000;502.333333333333;503.666666666667;505;506;507.000000000000;508;509.333333333333;510.666666666667;512;513;514;515;515.666666666667;516;517;518.333333333333;520;521;522;523.333333333333;524.666666666667;526;527;528;529;530;531.333333333333;532.666666666667;534;535;536;537;538;539.333333333333;540.666666666667;542;543;544;545.333333333333;546.666666666667;548;549;550;551;552;553.333333333333;554.333333333333;555.333333333333;556;557;558;559;560.333333333333;561.666666666667;563;564;565;566;567;568.333333333333;569.666666666667;571;572;573;572.333333333333;573.666666666667;575;578;579;580;581;582.333333333333;583.666666666667;585;586;587;588;589.333333333333;590.666666666667;592;592.666666666667;593.333333333333;594;595;596.333333333333;597.666666666667;599;600;601;602;603.333333333333;604.666666666667;606;607;608;609;611;612.333333333333;613.666666666667;614;615;616;617.333333333333;618.666666666667;620;621;622;623;623.666666666667;625;626.333333333333;628;629;629.666666666667;630.333333333333;631.333333333333;632.666666666667;634;635;636;637;638;639.333333333333;640.666666666667;642;643;644;645;646.333333333333;647.666666666667;649;650;651;652;653.333333333333;654.666666666667;656;657;658;659;660.333333333333;661.666666666667;663;664;665;666;666.666666666667;667.666666666667;668.666666666667;670;671;672;673;675;676.333333333333;677.666666666667;678;679;680;681.333333333333;682.666666666667;684;685;686;687;687.666666666667;689;690.333333333333;692;693;694;695.333333333333;696.666666666667;698;699;700;701;702;703.333333333333;704.666666666667;705.666666666667;706.333333333333;707;708;709.333333333333;710.666666666667;712;713;714;715;715.666666666667;717;718.333333333333;720;721;722;723;723.666666666667;725;726.333333333333;728;729;730;731.333333333333;732.666666666667;734;735;736.333333333333;737.666666666667;739.333333333333;740.666666666667;742;743;743.666666666667;744.333333333333;745;747;748.333333333333;749.666666666667;750;751;752;753.333333333333;754.666666666667;756;757;758;759;759.666666666667;761;762.333333333333;764;765;766;767;768.333333333333;769.666666666667;771;772.000000000000;773;774;775.333333333333;776.666666666667;778.000000000000;779;780;781.000000000000;781.666666666667;780.666666666667;781.666666666667;783;786;787.000000000000;788;789;788.333333333333;789.666666666667;791.000000000000;794;795;796.000000000000;797.333333333333;798.666666666667;800;801;802.000000000000;803;804;805.333333333333;806.666666666667;808.000000000000;809;810;811.000000000000;812;813.333333333333;814.666666666667;816;817.000000000000;818;818.666666666667;819.333333333333;820.000000000000;821.333333333333;822.666666666667;824;825;826.000000000000;827;828;829.333333333333;830.666666666667;832.000000000000;833;834;835.000000000000;835.666666666667;837.000000000000;838.333333333333;840;841.000000000000;842;843;844.000000000000;845.333333333333;846.666666666667;848;849;850.000000000000;851;852;853.333333333333;854.666666666667;856.000000000000;856.666666666667;857.333333333333;858;859.000000000000;860;861;862.333333333333;863.666666666667;865.000000000000;866;867;868.000000000000;869;870;871.333333333333;872.666666666667;874.000000000000;875;876;877.000000000000;878;879;880.000000000000;881.333333333333;882.666666666667;884;885;886.000000000000;887;888;889.000000000000;891;892.333333333333;893.333333333333;893.333333333333;894;895.000000000000;896;897;898.000000000000;899;900.666666666667;902.333333333333;904.000000000000;905;906;907.000000000000;908;909;910.000000000000;911.333333333333;912.666666666667;914;915.666666666667;916.666666666667;917.666666666667;918;919.000000000000;920;921.333333333333;922.666666666667;923.666666666667;925;926.333333333333;928.000000000000;929;929.666666666667;930.333333333333;931.000000000000;932;933;934.000000000000;935;936;937.333333333333;938.333333333333;939.666666666667;941;942.666666666667;944;945;946.000000000000;947;948;949.000000000000;950.333333333333;951.666666666667;953;954;955.000000000000;956;957;958.000000000000;959.333333333333;960.666666666667;962;963;964.333333333333;965.666666666667;967.000000000000;967.666666666667;968.333333333333;969;970.000000000000;971;972;973.000000000000;974;975;976.000000000000;977;978;979.000000000000;980;981;982.000000000000;983.333333333333;984.666666666667;986;987;988.000000000000;989;990;991.000000000000;992;993;994.000000000000;995;996;997.000000000000;998;999;1000.00000000000;1000.66666666667;1001.33333333333;1002;1003.00000000000;1004;1005;1006.00000000000;1007;1008;1009.00000000000;1010;1011;1012.00000000000;1013;1014;1015.00000000000;1016;1017;1018.00000000000;1019;1020;1021.00000000000;1022;1023;1024.00000000000;1024.33333333333;1025;1027;1028.33333333333;1029.33333333333;1029;1030;1031;1032;1032.66666666667;1033.33333333333;1034;1035;1036;1037;1038;1039;1040;1041;1042;1043;1044;1044.66666666667;1045.33333333333;1046;1047;1048;1049;1050;1051;1052;1053;1054;1053;1054;1055;1058;1059;1060;1061;1062;1063.33333333333;1064.33333333333;1065.66666666667;1067.33333333333;1068.33333333333;1069.33333333333;1069.66666666667;1071;1072;1073;1074;1075;1075.66666666667;1076.33333333333;1077;1078;1079;1080;1081;1081.66666666667;1082.33333333333;1083;1084;1085;1086;1087;1087.66666666667;1088.33333333333;1089;1090;1091;1092;1092.66666666667;1093.33333333333;1094;1094.66666666667;1095.33333333333;1096;1096.66666666667;1097.33333333333;1098;1099;1100;1100.66666666667;1101.33333333333;1102;1103;1104;1104.66666666667;1105.33333333333;1106;1107;1108;1108.66666666667;1109.33333333333;1110;1111;1111.66666666667;1112.33333333333;1113;1114;1114.66666666667;1115.33333333333;1116;1117;1117.66666666667;1118.33333333333;1119;1119.66666666667;1120.33333333333;1120.66666666667;1121.33333333333;1122;1123.66666666667;1124.33333333333;1125;1125;1125.66666666667;1126.33333333333;1127;1128;1128.66666666667;1129.33333333333;1130;1130.66666666667;1131.33333333333;1132;1132.66666666667;1133.33333333333;1134;1134.66666666667;1135.33333333333;1136;1136.66666666667;1137.33333333333;1138;1140;1140.66666666667;1141.33333333333;1140.66666666667;1141.33333333333;1141.66666666667;1142.33333333333;1142.66666666667;1143.33333333333;1144;1144.66666666667;1145.33333333333;1146;1146.66666666667;1147.33333333333;1147.66666666667;1148.33333333333;1149;1149.66666666667;1150.33333333333;1150.66666666667;1151.33333333333;1152;1152.66666666667;1153.33333333333;1153.66666666667;1154.33333333333;1154.66666666667;1155.33333333333;1156;1156.66666666667;1157.33333333333;1157.66666666667;1158.33333333333;1158.66666666667;1159.33333333333;1159.66666666667;1160.33333333333;1160.66666666667;1161;1161.33333333333;1162;1162.66666666667;1163.33333333333;1163.66666666667;1164.33333333333;1164.66666666667;1165.33333333333;1165.66666666667;1166.33333333333;1166.66666666667;1167.33333333333;1167.66666666667;1168.33333333333;1168.66666666667;];

% Filter the sampling to avoid problems
% filter_order = 50;
% a = 1;
% b = ones(1, filter_order)/filter_order;
% kClockSampling = filter(b,a,kClockSampling);


% first up-sampling the data
% nSamplesFFT = 2^nextpow2(2*ssOCTdefaults.NSAMPLES);
% using an FFT, zero padding and then performing IFFT.
% fixedSamplingFFT = fft(fixedSampling);
% kClockSampling = ifft(fft(kClockSampling,1170),nSamplesFFT);
% Usually two to four times up-sampling is sufficient for this application.

% fixedSampling = resample(fixedSampling,nSamplesFFT,ssOCTdefaults.NSAMPLES,FIRlength);
% kClockSampling = resample(kClockSampling,nSamplesFFT,ssOCTdefaults.NSAMPLES,FIRlength);

%%
% Resampling (Interpolation/Decimation) along columns (A-lines)
resampled_Bmodescan = interp1(kClockSampling, Bmodescan, fixedSampling, 'linear');

% Output Bmodescan is also an integer
if FLAG_int                             
    resampled_Bmodescan = uint16(resampled_Bmodescan);
end
